# Routes builds to run on our Trusty sudo-enabled infrastructure
# See using docker in builds: https://docs.travis-ci.com/user/docker/
sudo: required
services:
  - docker

language: ruby

env:
  global:
    - IMAGE_NAME=ljishen/perf
    - VERSION=4.9

script:
  # Generate the Dockerfile for different architectures
  - bash update.sh

  # Build amd64 images
  - docker build -t "${IMAGE_NAME}":amd64-"${VERSION}" . -f debian/Dockerfile.amd64
  - docker build -t "${IMAGE_NAME}":amd64-"${VERSION}"-python3 . -f debian-python3/Dockerfile.amd64

  # Configure binfmt-support on the Docker host
  # See https://github.com/multiarch/alpine
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset

  # Build arm64v8 image
  - docker build -t "${IMAGE_NAME}":arm64v8-"${VERSION}" . -f debian/Dockerfile.arm64v8
  - docker build -t "${IMAGE_NAME}":arm64v8-"${VERSION}"-python3 . -f debian-python3/Dockerfile.arm64v8

before_deploy:
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"

deploy:
  provider: script
  script:
    - docker push "${IMAGE_NAME}":amd64-"${VERSION}"
    - docker push "${IMAGE_NAME}":arm64v8-"${VERSION}"
    - docker push "${IMAGE_NAME}":amd64-"${VERSION}"-python3
    - docker push "${IMAGE_NAME}":arm64v8-"${VERSION}"-python3
  on:
    branch: master
